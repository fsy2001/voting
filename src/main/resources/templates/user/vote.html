<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh">
<head>
    <title>2024毕业之夜人物投票</title>
    <meta name="viewport" content="width=device-width"/>
    <link rel="stylesheet" href="https://unpkg.com/lu2/theme/edge/css/common/ui.css">
    <link rel="stylesheet" href="/css/sheet.css">
    <script type="module" src="https://unpkg.com/lu2/theme/edge/js/common/all.js"></script>

    <style>
        body {
            background-image: url("/image/background.png");
        }

        .nominee {
            margin-top: 30px;
        }

        .nominee-pic {
            width: 100%;
            border-radius: 10px;
        }
    </style>

</head>
<body>

<main class="sheet">
    <h1 class="title">投票</h1>

    <span class="ui-input ui-input-search" align="end">
        <label for="searchBox"></label>
        <input id="searchBox" onkeyup="searchFunction()" type="search" placeholder="搜索">
        <button class="ui-icon-search">搜索</button>
    </span>

    <div th:each="song : ${songs}" class="nominee card" th:attr="data-name=${song.name}">
        <h2 th:text="${song.name}" class="nomineeName"></h2>
        <img class="nominee-pic" th:src="@{'/images/' + ${song.pic}}" alt="图片">
        <p th:text="${song.intro}"></p>
        <p th:text="${song.reason}"></p>
        <p>票数：
            <span th:if="${votesVisible}" th:text="${song.votes}" class="votes"></span>
            <span th:unless="${votesVisible}">***</span>
        </p>
        <button class="ui-button" onclick="voteForNominee(this)" th:attr="data-id=${song.id}">投票</button>
    </div>
</main>

<ui-lighttip id="success"></ui-lighttip>
<ui-lighttip id="failed" type="error">
    <p>
        <span id="failed-reason"></span>
    </p>
</ui-lighttip>

<script>
    function searchFunction() {
        let searchBox = document.getElementById('searchBox')
        let searchWord = searchBox.value
        let songs = document.getElementsByClassName('nominee')
        for (let i = 0; i < songs.length; i++) {
            let songName = songs[i].getAttribute('data-name')
            if (songName.includes(searchWord) || searchWord === '') {
                songs[i].style.display = 'block'
            } else {
                songs[i].style.display = 'none'
            }
        }
    }

    async function voteForNominee(button) {
        let id = button.getAttribute('data-id')
        let response = await fetch(`/api/vote?songId=${id}`)
        let result = await response.text()
        if (response.ok) {
            let successTip = document.getElementById('success')
            successTip.innerText = result
            successTip.open = true
            let votesSpan = button.previousElementSibling.children[0]
            let previousVoteCount = parseInt(votesSpan.textContent)
            if (!isNaN(previousVoteCount)) {
                votesSpan.textContent = String(previousVoteCount + 1)
            }
        } else {
            let failedTip = document.getElementById('failed')
            let failedReason = document.getElementById('failed-reason')
            failedReason.innerText = result
            failedTip.open = true
        }
    }
</script>
</body>
</html>